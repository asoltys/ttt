$.extend($.ui.dialog.prototype.options,{modal:!0}),$.ui.plugin.add("draggable","alsoDrag",{start:function(){var t=$(this).data("ui-draggable"),n=t.options,e=function(t){$(t).each(function(){var t=$(this);t.data("ui-draggable-alsoDrag",{top:parseInt(t.css("top"),10),left:parseInt(t.css("left"),10)})})};"object"!=typeof n.alsoDrag||n.alsoDrag.parentNode?e(n.alsoDrag):n.alsoDrag.length?(n.alsoDrag=n.alsoDrag[0],e(n.alsoDrag)):$.each(n.alsoDrag,function(t){e(t)})},drag:function(){var t=$(this).data("ui-draggable"),n=t.options,e=(t.originalSize,t.originalPosition),a={top:t.position.top-e.top||0,left:t.position.left-e.left||0},i=function(t,n){$(t).each(function(){var t=$(this),n=$(this).data("ui-draggable-alsoDrag"),e={},i=["top","left"];$.each(i,function(t,i){var o=(n[i]||0)+(a[i]||0);e[i]=o||null}),t.css(e)})};"object"!=typeof n.alsoDrag||n.alsoDrag.nodeType?i(n.alsoDrag):$.each(n.alsoDrag,function(t,n){i(t,n)})},stop:function(t,n){$(this).removeData("draggable-alsoDrag")}});var helpers=function(t){var n=function(n,e,a,i){return 3==arguments.length?t.ajax({type:n,url:e,cache:!1,success:function(t){a(JSON.stringify(t))},error:function(t,n,e){console.log(JSON.stringify(t)+", "+n)}}):t.ajax({type:n,contentType:"application/json",url:e,cache:!1,data:JSON.stringify(i),success:function(t){a(JSON.stringify(t))},error:function(t,n,e){console.log(JSON.stringify(t)+", "+n)}})},e=function(t){return JSON.parse(JSON.stringify(t))},a=function(n){return t("<div/>").html(n).text()},i=function(n){return t("<div/>").text(n).html()},o=function(t,n){return t>n?1:n>t?-1:0},r=function(t,n){return t.length>=n?t.substring(0,n)+"...":t},c=function(t,n,e){return t in n?1==e?n[t]:!0:!1};return{ajax:n,jsonCopy:e,htmlDecode:a,htmlEncode:i,sortComparator:o,truncate:r,keyExists:c}}($),timeline=function(t,n,e,a){var i=window.location.href.indexOf("lang=fra")>-1?"fr-ca":"en-ca",o="en-ca"==i?"E":"F",r="Name"+o,c="Text"+o,s="Description"+o,l="Hover"+o,u="MM/DD/YYYY",d="post";e.locale(i);var f=function(t,n){var e,a,c,s,l,f,m,p="/data/all",g="/data/regions",v="/data/branches",D=3,b="month",y=!1,w="all",C="all",x="all",E=moment(),S=moment(),M=function(){return N(),k(),I(),$(),t.Deferred().resolve().promise()},N=function(){a=j(a);var t;a=a.filter(function(n){return"nca"==n.NameShort&&(t=n),"nca"!=n.NameShort}),a.unshift(t)},k=function(){c=j(c)},I=function(){var t,n,a=[],i=[];e.forEach(function(e,o,r){e.Data.forEach(function(t,n,e){a.push(moment(t.StartDate,u)),i.push(moment(t.EndDate,u))}),t=a.reduce(function(t,n){return n>t?t:n}),n=i.reduce(function(t,n){return t>n?t:n})}),t.subtract(D,b),n.add(D,b);var o=moment.duration(n.diff(t));s={Start:t,End:n,Duration:{Days:Math.ceil(o.asDays()),Months:Math.ceil(o.asMonths()),Years:Math.ceil(o.asYears())}}},$=function(){l=n.jsonCopy(e),f=n.jsonCopy(a),m=n.jsonCopy(c)},j=function(t){return t.sort(function(t,e){return n.sortComparator(t["Name"+o],e["Name"+o])})},O=function(t,n){return t=""==t?moment().format("MM/DD/YY").split("/"):t.split("/"),1==n?(E.set("month",t[0]-1),E.set("date",t[1]),E.set("year",t[2]),E):(S.set("month",t[0]-1),S.set("date",t[1]),S.set("year",t[2]),S)},Y=function(){return S.diff(E)},T=function(){y=!0},q=function(){return y},H=function(){T(),h.unlock()},J=function(){return l},W=function(){return f},A=function(){return m},L=function(){return s},z=(function(){n.ajax(d,p,function(t){e=JSON.parse(t)},i).then(n.ajax(d,g,function(t){a=JSON.parse(t)})).then(n.ajax(d,v,function(t){c=JSON.parse(t)})).then(M).then(H)}(),function(t){return l=n.jsonCopy(e),"all"==w?void l.forEach(function(t){j(t.Data)}):void l.forEach(function(t){t.Skip=t[r]!=w})}),B=function(){z(w),"all"!=C&&"all"!=x&&l.forEach(function(t){t.Data.forEach(function(t){var e=n.keyExists(Q(),t.Impacts,!0);t.Weight=0==e?0:e,t.Events.forEach(function(t){t.Skip=!n.keyExists(Q(),t.Control,!1)})}),t.Data.sort(function(t,e){return n.sortComparator(e.Weight,t.Weight)||n.sortComparator(t[r],e[r])})})},R=function(t){w=t},F=function(t){C=t},P=function(t){x=t},Q=function(){return C+","+x},G=function(){return{region:C,branch:x}};return{loaded:q,timelines:J,regions:W,branches:A,timespan:L,filter:B,setTimeline:R,setRegion:F,setBranch:P,getControl:Q,getControlObject:G,momentize:O,momentDiff:Y}}(n,a),h=function(t,n,e,a){var i=100,r=function(){l(),s(),u(),h.renderer.draw(a.timelines()),c(),n("#timeline-tool-nav-space").height(n("#timeline-tool-nav-container").height())},c=function(){n("#timeline-tool-loading-icon").addClass("hide"),n("#timeline-tool").removeClass("hide")},s=function(){var e=n("#nav-calendar"),o=n("#nav-calendar-container"),r=n("#nav-calendar-quarter"),c=n("#nav-calendar-month"),s=n("#dynamic-content-container"),l=(n("#timeline-tool-nav-container"),n("#timeline-tool-nav-space"),a.timespan()),u=function(){f(),h(),m(),d()},d=function(){var t=-1*o.width()+e.width(),a="#nav-calendar-container";s.draggable({axis:"x",alsoDrag:a,stop:function(e,i){i.position.left>0?(n(this).animate({left:"0px"},300),n(a).animate({left:"0px"},300)):i.position.left<t&&(n(this).animate({left:t},300),n(a).animate({left:t},300))}})},f=function(){o.css("width",l.Duration.Months*i),s.css("width",l.Duration.Months*i)},h=function(){for(var t=l.Start.clone(),n=0;n<l.Duration.Months;n++,t.add(1,"month"))r.append(p(t.month()));r.append(y())},m=function(){for(var t=l.Start.clone(),n=0;n<l.Duration.Months;n++,t.add(1,"month"))c.append(g(t));c.append(y())},p=function(t){var n=v(t),e=b(t),a="<div class='"+e+"' style='width:"+i+"px;'>";return a+=n,a+="</div>"},g=function(t){var n=D(t),e=b(t.month()),a="<div class='"+e+"' style='width:"+i+"px;'>";return a+=n,a+="</div>"},v=function(n){n++;var e="| "+t.ReportQuarterPrefix;switch(n){case 4:e+="1";break;case 7:e+="2";break;case 10:e+="3";break;case 1:e+="4";break;default:e="&nbsp;"}return e},D=function(t){var n=t.month()+1,e=t.format("MMM"),a=t.year();switch(n){case 4:case 7:case 10:case 1:e="| "+e+" "+a;break;default:e="| "+e}return e},b=function(t){switch(t++,t){case 1:case 2:case 3:return"fourth-quarter";case 4:case 5:case 6:return"first-quarter";case 7:case 8:case 9:return"second-quarter";case 10:case 11:case 12:return"third-quarter";default:return"first-quarter"}},y=function(){return"<div class='clear'></div>"},w=(function(){u()}(),function(){return i});return{monthWidth:w}},l=function(){var i=(n("#nav-go-left-button"),n("#nav-go-right-button"),n("#nav-controller-timeline")),r=n("#nav-controller-region"),c=n("#nav-controller-branch"),s=function(t,n){var e=t,a=document.createElement("option");a.text=n.text,a.value=n.value,e.append(a)},l=function(){a.timelines().forEach(function(n,e,a){var r=n["Name"+o],c=t[r];s(i,{text:c,value:r})})},u=function(){a.regions().forEach(function(t,n,e){var a=t["Name"+o];s(r,{text:a,value:t.ID})}),a.branches().forEach(function(t,n,a){var i=t["Name"+o];i=e.truncate(i,45),s(c,{text:i,value:t.ID})})};(function(){l(),u()})()},u=function(){var e,o,r,c=n("#nav-go-left-button"),s=n("#nav-go-right-button"),l=n("#nav-controller-timeline"),u=n("#nav-controller-region"),d=n("#nav-controller-branch"),f=n("#timeline-tool-nav-container"),m=n("#nav-calendar"),p=n("#nav-calendar-container"),g=(n("#timeline-tool-nav-space"),n("#dynamic-description-container")),v=n("#dynamic-content-container"),D=n("#timeline-tool-start-over"),b=n("#dialog"),y=n("#wb-main-in"),w=n("body"),C=n(document),x=n(window),E=function(){var t=parseInt(p.css("left"),10),n=2*i;n=t+n>=0?0:t+n,M(n)},S=function(){var t=-1*p.width()+m.width(),n=parseInt(p.css("left"),10),e=2*i;e=n-e>t?n-e:t,M(e)},M=function(t){p.css("left",t+"px"),v.css("left",t+"px")},N=function(){a.setTimeline(this.value),a.filter(),h.renderer.sort(a.timelines())},k=function(){a.setRegion(this.value),a.filter(),h.renderer.sort(a.timelines())},I=function(){a.setBranch(this.value),a.filter(),h.renderer.sort(a.timelines())},$=function(t){!b.dialog("isOpen")||n(t.target).is("img, a, p")||n(t.target).closest(".ui-dialog").length||b.dialog("close")},j=function(){var t=n(this).attr("data-weight"),e=n(".description-box[data-weight="+t+"],.bar[data-weight="+t+"]");e.addClass("hide"),T(n(this))},O=function(){var t=n(this).attr("data-weight"),e=n(".description-box[data-weight="+t+"],.bar[data-weight="+t+"]");e.removeClass("hide"),T(n(this))},Y=function(t){switch(t.keyCode){case 37:return void E();case 39:return void S();default:return}},T=function(n){n.hasClass("hide-button")?(n.removeClass("hide-button"),n.addClass("show-button"),n.text(t.Show)):(n.removeClass("show-button"),n.addClass("hide-button"),n.text(t.Hide))},q=function(){null==e&&(e=f.offset().top,o=e-y.offset().top,r=!1);var t=x.scrollTop(),n=v.offset().top+v.height()-f.height();0==r&&t>e?n>t&&(r=!0,f.css({top:0,position:"fixed"})):1==r&&(e>=t||t>=n)&&(r=!1,f.css({top:o,position:"absolute"}))},H=function(){l.val("all"),u.val("all"),d.val("all"),l.trigger("change"),u.trigger("change"),d.trigger("change")};(function(){C.tooltip({items:":not(.ui-button)"}),b.dialog({autoOpen:!1,width:"50%",maxWidth:"768px"}),c.on("click",E),s.on("click",S),l.on("change",N),u.on("change",k),d.on("change",I),C.on("keydown",Y),w.bind("click",$),g.on("click",".description",function(){h.renderer.openDialog(n(this))}),v.on("click",".icon",function(){h.renderer.openDialog(n(this))}),g.on("click",".hide-button",j),g.on("click",".show-button",O),x.on("scroll",q),D.on("click",H)})()};return{unlock:r}}(t,n,a,f);return h.renderer=function(e){var a,i,o,u,d=document.querySelector("#dynamic-description-container"),f=n("#dynamic-description-container"),h=document.querySelector("#dynamic-content-container"),m=n("#dynamic-content-container"),p=document.querySelector("#nav-calendar-container"),g=100,v=moment().format("MM/DD/YY"),D=function(t,n){return e.momentize(t,1),e.momentize(n,2),Math.floor(e.momentDiff()/i*a)},b=function(t){return e.momentize(t.StartDate,1),e.momentize(t.EndDate,2),Math.floor(e.momentDiff()/i*a)},y=function(t,n){var e,a,i,o,r,s=12;return t.Events.forEach(function(u,d){a=D(t.StartDate,u.Date)-s,i="Milestone"==u.Type?"circle.png":"book.png",o=u[l],r=u[c],e=document.createElement("img"),e.id="event-"+u.ID,e.src="/timeline/img/"+i,e.className=null!=r?"icon icon-click":"icon",e.title=o,e.style.marginLeft=a+"px",e.setAttribute("data-title",o),e.setAttribute("data-description",r),n.appendChild(e)}),n},w=function(t,n){var e=document.createElement("div"),a=document.createElement("div"),i=b(t),o=D(timespan.Start,t.StartDate);return e.id="initiative-"+t.ID,e.className="bar "+n,a.className="duration",a.style.width=i+"px",a.style.marginLeft=o+"px",a=y(t,a),e.appendChild(a),e},C=function(t,n){var e=t[r],a=t[s],i=document.createElement("div"),o=document.createElement("p");return i.id="initiative-description-"+t.ID,i.className="description-box "+n,o.className="description",o.setAttribute("data-title",e),o.setAttribute("data-description",a),o.innerHTML=e,i.appendChild(o),i},x=function(t){d.appendChild(C(t,this)),h.appendChild(w(t,this))},E=function(t){var n=t[r];t.Data.forEach(x,n)},S=function(){d.innerHTML="",h.innerHTML="",timespan=e.timespan(),void 0!=a&&void 0!=i||(a=timespan.Duration.Months*g,i=timespan.End.diff(timespan.Start),timespan.Start=timespan.Start.format("MM/DD/YY"),timespan.End=timespan.End.format("MM/DD/YY"))},M=function(n,e){var a,i,o,r;return a=document.createElement("div"),a.className="hide impact-statement "+e,a.setAttribute("data-weight",n),i=document.createElement("p"),i.innerHTML=H(n),o=document.createElement("a"),o.innerHTML=t.Hide,o.className="hide-button",o.setAttribute("data-weight",n),a.appendChild(i),a.appendChild(o),r=document.createElement("div"),r.className="hide impact-statement-space "+e,r.setAttribute("data-weight",n),[a,r]},N=function(){var t,n,e,a;a=[3,2,1,0,4];for(var i=0,o=a.length;o>i;i++)t=a[i],n=J(a[i],!1),e=M(t,n),d.appendChild(e[0]),h.appendChild(e[1])},k=function(){var t=m.parent().width();void 0==o&&(o=-1*D(timespan.Start,v)+Math.floor(t/2)),requestAnimationFrame(function(){I(),p.style.left=o+"px",h.style.left=o+"px"})},I=function(){var t="<img src='/timeline/img/red.gif' id='today' style='margin-left:"+D(timespan.Start,v)+"px' />",e=m.children(".impact-statement-space"),a=e.length>0;a?n(t).insertAfter(e.first()):m.prepend(t)},$=function(t){return null==t?"no argument was passed in":(S(),N(),t.forEach(E),void k())},j=function(t,n){return(n.match(/\S+color-content($|\s)/g)||[]).join(" ")},O=function(){f.find(".description-box").attr({style:"order: 0","data-order":"0"}).removeClass(j),m.find(".bar").attr({style:"order: 0","data-order":"0"}).removeClass(j),m.find(".icon").removeClass("hide"),$showButtons=n(".show-button"),$showButtons.each(function(){n(this).removeClass("show-button").addClass("hide-button").text(t.Hide)})},Y=function(){u.forEach(function(t){var e="."+t[r];1==t.Skip?n(e).addClass("hide"):n(e).removeClass("hide")})},T=function(){u.forEach(function(t){t.Data.forEach(function(t){if(void 0==t.Weight)return!1;var e=void 0==t.Weight?0:W(t.Weight),a=J(t.Weight,!0),i=t.ID,o="#initiative-description-"+i,r="#initiative-"+i,c=t.Weight.toString();n(o).attr({style:"order: "+e,"data-order":e,"data-weight":c}).addClass(a),n(r).attr({style:"order: "+e,"data-order":e,"data-weight":c}).addClass(a),t.Events.forEach(function(t){if(void 0==t.Skip)return!1;var e="#event-"+t.ID;1==t.Skip?n(e).addClass("hide"):n(e).removeClass("hide")})})})},q=function(){for(var t,e,a,i,o=[3,2,1,0,4],r=0,c=o.length;c>r;r++)t=n(".description-box[data-weight='"+o[r]+"']:not(.hide)").first(),e=n(".impact-statement[data-weight='"+o[r]+"']").first(),a=n(".impact-statement-space[data-weight='"+o[r]+"']").first(),i=t.attr("data-order"),t.length>0&&void 0!=i&&i>0?(e.attr({style:"order: "+i}).removeClass("hide"),a.attr({style:"order: "+i}).removeClass("hide")):(e.addClass("hide"),a.addClass("hide"))},H=function(n){switch(n){case 0:return t.NoImpact;case 1:return t.LowImpact;case 2:return t.MediumImpact;case 3:return t.HighImpact;case 4:return t.BlueprintImpact;default:return t.NoImpact}},J=function(t,n){switch(t){case 0:return 1==n?"no-impact-color-content":"no-impact-color";case 1:return 1==n?"low-impact-color-content":"low-impact-color";case 2:return 1==n?"medium-impact-color-content":"medium-impact-color";case 3:return 1==n?"high-impact-color-content":"high-impact-color";case 4:return 1==n?"blueprint-impact-color-content":"blueprint-impact-color";default:return 1==n?"no-impact-color-content":"no-impact-color"}},W=function(t){switch(t){case 0:return 4;case 1:return 3;case 2:return 2;case 3:return 1;case 4:return 5;default:return 4}},A=function(t){u=t,O(),Y(),T(),q()},L=function(t){var e="",a="";e=t.attr("data-title"),a=t.attr("data-description"),""!=a&&"null"!=a&&(n("#dialog").html(a),n("#ui-id-1").html(e),n("#dialog").dialog("open"))};return{draw:$,sort:A,openDialog:L}}(f),{dataManager:f,ui:h}}(resources,jQuery,moment,helpers);