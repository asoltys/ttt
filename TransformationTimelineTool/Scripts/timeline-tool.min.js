$.extend($.ui.dialog.prototype.options,{modal:!0}),$.ui.plugin.add("draggable","alsoDrag",{start:function(){var t=$(this).data("ui-draggable"),n=t.options,e=function(t){$(t).each(function(){var t=$(this);t.data("ui-draggable-alsoDrag",{top:parseInt(t.css("top"),10),left:parseInt(t.css("left"),10)})})};"object"!=typeof n.alsoDrag||n.alsoDrag.parentNode?e(n.alsoDrag):n.alsoDrag.length?(n.alsoDrag=n.alsoDrag[0],e(n.alsoDrag)):$.each(n.alsoDrag,function(t){e(t)})},drag:function(){var t=$(this).data("ui-draggable"),n=t.options,e=(t.originalSize,t.originalPosition),a={top:t.position.top-e.top||0,left:t.position.left-e.left||0},i=function(t,n){$(t).each(function(){var t=$(this),n=$(this).data("ui-draggable-alsoDrag"),e={},i=["top","left"];$.each(i,function(t,i){var o=(n[i]||0)+(a[i]||0);e[i]=o||null}),t.css(e)})};"object"!=typeof n.alsoDrag||n.alsoDrag.nodeType?i(n.alsoDrag):$.each(n.alsoDrag,function(t,n){i(t,n)})},stop:function(t,n){$(this).removeData("draggable-alsoDrag")}});var helpers=function(t){var n=function(n,e,a,i){return 3==arguments.length?t.ajax({type:n,url:e,cache:!1,success:function(t){a(JSON.stringify(t))},error:function(t,n,e){console.log(JSON.stringify(t)+", "+n)}}):t.ajax({type:n,contentType:"application/json",url:e,cache:!1,data:JSON.stringify(i),success:function(t){a(JSON.stringify(t))},error:function(t,n,e){console.log(JSON.stringify(t)+", "+n)}})},e=function(t){return JSON.parse(JSON.stringify(t))},a=function(n){return t("<div/>").html(n).text()},i=function(n){return t("<div/>").text(n).html()},o=function(t,n){return t>n?1:n>t?-1:0},r=function(t,n){return t.length>=n?t.substring(0,n)+"...":t},c=function(t,n,e){return t in n?1==e?n[t]:!0:!1};return{ajax:n,jsonCopy:e,htmlDecode:a,htmlEncode:i,sortComparator:o,truncate:r,keyExists:c}}($),timeline=function(t,n,e,a){var i=window.location.href.indexOf("lang=fra")>-1?"fr-ca":"en-ca",o="en-ca"==i?"E":"F",r="Name"+o,c="Text"+o,s="Description"+o,l="Hover"+o,u="MM/DD/YYYY",d="post";e.locale(i);var f=function(t,n){var e,a,c,s,l,f,m,p="/data/all",g="/data/regions",v="/data/branches",D=3,b="month",y=!1,w="all",x="all",C="all",E=moment(),S=moment(),M=function(){return N(),k(),I(),$(),t.Deferred().resolve().promise()},N=function(){a=j(a);var t;a=a.filter(function(n){return"nca"==n.NameShort&&(t=n),"nca"!=n.NameShort}),a.unshift(t)},k=function(){c=j(c)},I=function(){var t,n,a=[],i=[];e.forEach(function(e,o,r){e.Data.forEach(function(t,n,e){a.push(moment(t.StartDate,u)),i.push(moment(t.EndDate,u))}),t=a.reduce(function(t,n){return n>t?t:n}),n=i.reduce(function(t,n){return t>n?t:n})}),t.subtract(D,b),n.add(D,b);var o=moment.duration(n.diff(t));s={Start:t,End:n,Duration:{Days:Math.ceil(o.asDays()),Months:Math.ceil(o.asMonths()),Years:Math.ceil(o.asYears())}}},$=function(){l=n.jsonCopy(e),f=n.jsonCopy(a),m=n.jsonCopy(c)},j=function(t){return t.sort(function(t,e){return n.sortComparator(t["Name"+o],e["Name"+o])})},O=function(t,n){return t=""==t?moment().format("MM/DD/YY").split("/"):t.split("/"),1==n?(E.set("month",t[0]-1),E.set("date",t[1]),E.set("year",t[2]),E):(S.set("month",t[0]-1),S.set("date",t[1]),S.set("year",t[2]),S)},Y=function(){return S.diff(E)},T=function(){y=!0},q=function(){return y},H=function(){T(),h.unlock()},J=function(){return l},W=function(){return f},A=function(){return m},L=function(){return s},z=(function(){n.ajax(d,p,function(t){e=JSON.parse(t)},i).then(n.ajax(d,g,function(t){a=JSON.parse(t)})).then(n.ajax(d,v,function(t){c=JSON.parse(t)})).then(M).then(H)}(),function(t){return l=n.jsonCopy(e),"all"==w?void l.forEach(function(t){j(t.Data)}):void l.forEach(function(t){t.Skip=t[r]!=w})}),B=function(){z(w),"all"!=x&&"all"!=C&&l.forEach(function(t){t.Data.forEach(function(t){var e=n.keyExists(Q(),t.Impacts,!0);t.Weight=0==e?0:e,t.Events.forEach(function(t){t.Skip=!n.keyExists(Q(),t.Control,!1)})}),t.Data.sort(function(t,e){return n.sortComparator(e.Weight,t.Weight)||n.sortComparator(t[r],e[r])})})},F=function(t){w=t},R=function(t){x=t},P=function(t){C=t},Q=function(){return x+","+C},G=function(){return{region:x,branch:C}};return{loaded:q,timelines:J,regions:W,branches:A,timespan:L,filter:B,setTimeline:F,setRegion:R,setBranch:P,getControl:Q,getControlObject:G,momentize:O,momentDiff:Y}}(n,a),h=function(t,n,e,a){var i=100,r=function(){l(),s(),u(),h.renderer.draw(a.timelines()),c(),n("#timeline-tool-nav-space").height(n("#timeline-tool-nav-container").height())},c=function(){n("#timeline-tool-loading-icon").addClass("hide"),n("#timeline-tool").removeClass("hide")},s=function(){var e=n("#nav-calendar"),o=n("#nav-calendar-container"),r=n("#nav-calendar-quarter"),c=n("#nav-calendar-month"),s=n("#dynamic-content-container"),l=(n("#timeline-tool-nav-container"),n("#timeline-tool-nav-space"),a.timespan()),u=function(){f(),h(),m(),d()},d=function(){var t=-1*o.width()+e.width(),a="#nav-calendar-container";s.draggable({axis:"x",alsoDrag:a,stop:function(e,i){i.position.left>0?(n(this).animate({left:"0px"},300),n(a).animate({left:"0px"},300)):i.position.left<t&&(n(this).animate({left:t},300),n(a).animate({left:t},300))}})},f=function(){o.css("width",l.Duration.Months*i),s.css("width",l.Duration.Months*i)},h=function(){for(var t=l.Start.clone(),n=0;n<l.Duration.Months;n++,t.add(1,"month"))r.append(p(t.month()));r.append(y())},m=function(){for(var t=l.Start.clone(),n=0;n<l.Duration.Months;n++,t.add(1,"month"))c.append(g(t));c.append(y())},p=function(t){var n=v(t),e=b(t),a="<div class='"+e+"' style='width:"+i+"px;'>";return a+=n,a+="</div>"},g=function(t){var n=D(t),e=b(t.month()),a="<div class='"+e+"' style='width:"+i+"px;'>";return a+=n,a+="</div>"},v=function(n){n++;var e="| "+t.ReportQuarterPrefix;switch(n){case 4:e+="1";break;case 7:e+="2";break;case 10:e+="3";break;case 1:e+="4";break;default:e="&nbsp;"}return e},D=function(t){var n=t.month()+1,e=t.format("MMM"),a=t.year();switch(n){case 4:case 7:case 10:case 1:e="| "+e+" "+a;break;default:e="| "+e}return e},b=function(t){switch(t++,t){case 1:case 2:case 3:return"fourth-quarter";case 4:case 5:case 6:return"first-quarter";case 7:case 8:case 9:return"second-quarter";case 10:case 11:case 12:return"third-quarter";default:return"first-quarter"}},y=function(){return"<div class='clear'></div>"},w=(function(){u()}(),function(){return i});return{monthWidth:w}},l=function(){var i=(n("#nav-go-left-button"),n("#nav-go-right-button"),n("#nav-controller-timeline")),r=n("#nav-controller-region"),c=n("#nav-controller-branch"),s=function(t,n){var e=t,a=document.createElement("option");a.text=n.text,a.value=n.value,e.append(a)},l=function(){a.timelines().forEach(function(n,e,a){var r=n["Name"+o],c=t[r];s(i,{text:c,value:r})})},u=function(){a.regions().forEach(function(t,n,e){var a=t["Name"+o];s(r,{text:a,value:t.ID})}),a.branches().forEach(function(t,n,a){var i=t["Name"+o];i=e.truncate(i,40),s(c,{text:i,value:t.ID})})};(function(){l(),u()})()},u=function(){var o,r,c,s=n("#nav-go-left-button"),l=n("#nav-go-right-button"),u=n("#nav-controller-timeline"),d=n("#nav-controller-region"),f=n("#nav-controller-branch"),m=n("#timeline-tool-nav-container"),p=n("#nav-calendar"),g=n("#nav-calendar-container"),v=(n("#timeline-tool-nav-space"),n("#dynamic-description-container")),D=n("#dynamic-content-container"),b=n("#timeline-tool-start-over"),y=n("#dialog"),w=n("#wb-main-in"),x=n("body"),C=n(document),E=n(window),S=!1,M=function(){var t=parseInt(g.css("left"),10),n=2*i;n=t+n>=0?0:t+n,k(n)},N=function(){var t=-1*g.width()+p.width(),n=parseInt(g.css("left"),10),e=2*i;e=n-e>t?n-e:t,k(e)},k=function(t){g.css("left",t+"px"),D.css("left",t+"px")},I=function(){a.setTimeline(this.value),a.filter(),h.renderer.sort(a.timelines())},$=function(){a.setRegion(this.value),a.filter(),h.renderer.sort(a.timelines())},j=function(){a.setBranch(this.value),a.filter(),h.renderer.sort(a.timelines()),"all"==this.value||S||(S=!0,setTimeout(function(){h.renderer.openDialog({title:"&nbsp;",text:e.htmlDecode(t.InitialFilterSplash)},!1)},1))},O=function(t){!y.dialog("isOpen")||n(t.target).is("img, a, p")||n(t.target).closest(".ui-dialog").length||y.dialog("close")},Y=function(){var t=n(this).attr("data-weight"),e=n(".description-box[data-weight="+t+"],.bar[data-weight="+t+"]");e.addClass("hide"),H(n(this))},T=function(){var t=n(this).attr("data-weight"),e=n(".description-box[data-weight="+t+"],.bar[data-weight="+t+"]");e.removeClass("hide"),H(n(this))},q=function(t){switch(t.keyCode){case 37:return void M();case 39:return void N();default:return}},H=function(n){n.hasClass("hide-button")?(n.removeClass("hide-button"),n.addClass("show-button"),n.text(t.Show)):(n.removeClass("show-button"),n.addClass("hide-button"),n.text(t.Hide))},J=function(){null==o&&(o=m.offset().top,r=o-w.offset().top,c=!1);var t=E.scrollTop(),n=D.offset().top+D.height()-m.height();0==c&&t>o?n>t&&(c=!0,m.css({top:0,position:"fixed"})):1==c&&(o>=t||t>=n)&&(c=!1,m.css({top:r,position:"absolute"}))},W=function(){u.val("all"),d.val("all"),f.val("all"),u.trigger("change"),d.trigger("change"),f.trigger("change"),S=!1};(function(){C.tooltip({items:":not(.ui-button)"}),y.dialog({autoOpen:!1,width:"50%",maxWidth:"768px"}),s.on("click",M),l.on("click",N),u.on("change",I),d.on("change",$),f.on("change",j),C.on("keydown",q),x.bind("click",O),v.on("click",".description",function(){h.renderer.openDialog(n(this),!0)}),D.on("click",".icon",function(){h.renderer.openDialog(n(this),!0)}),v.on("click",".hide-button",Y),v.on("click",".show-button",T),E.on("scroll",J),b.on("click",W)})()};return{unlock:r}}(t,n,a,f);return h.renderer=function(e){var i,o,u,d,f=document.querySelector("#dynamic-description-container"),h=n("#dynamic-description-container"),m=document.querySelector("#dynamic-content-container"),p=n("#dynamic-content-container"),g=document.querySelector("#nav-calendar-container"),v=100,D=moment().format("MM/DD/YY"),b=function(t,n){return e.momentize(t,1),e.momentize(n,2),Math.floor(e.momentDiff()/o*i)},y=function(t){return e.momentize(t.StartDate,1),e.momentize(t.EndDate,2),Math.floor(e.momentDiff()/o*i)},w=function(t,n){var e,a,i,o,r,s=12;return t.Events.forEach(function(u,d){a=b(t.StartDate,u.Date)-s,i="Milestone"==u.Type?"circle.png":"book.png",o=u[l],r=u[c],e=document.createElement("img"),e.id="event-"+u.ID,e.src="/timeline/img/"+i,e.className=null!=r?"icon icon-click":"icon",e.title=o,e.style.marginLeft=a+"px",e.setAttribute("data-title",o),e.setAttribute("data-description",r),n.appendChild(e)}),n},x=function(t,n){var e=document.createElement("div"),a=document.createElement("div"),i=y(t),o=b(timespan.Start,t.StartDate);return e.id="initiative-"+t.ID,e.className="bar "+n,a.className="duration",a.style.width=i+"px",a.style.marginLeft=o+"px",a=w(t,a),e.appendChild(a),e},C=function(t,n){var e=t[r],i=t[s],o=document.createElement("div"),c=document.createElement("p");return o.id="initiative-description-"+t.ID,o.className="description-box "+n,c.className="description",c.setAttribute("data-title",e),c.setAttribute("data-description",i),c.innerHTML=a.truncate(e,60),o.appendChild(c),o},E=function(t){f.appendChild(C(t,this)),m.appendChild(x(t,this))},S=function(t){var n=t[r];t.Data.forEach(E,n)},M=function(){f.innerHTML="",m.innerHTML="",timespan=e.timespan(),void 0!=i&&void 0!=o||(i=timespan.Duration.Months*v,o=timespan.End.diff(timespan.Start),timespan.Start=timespan.Start.format("MM/DD/YY"),timespan.End=timespan.End.format("MM/DD/YY"))},N=function(n,e){var a,i,o,r;return a=document.createElement("div"),a.className="hide impact-statement "+e,a.setAttribute("data-weight",n),i=document.createElement("p"),i.innerHTML=J(n),o=document.createElement("a"),o.innerHTML=t.Hide,o.className="hide-button",o.setAttribute("data-weight",n),a.appendChild(i),a.appendChild(o),r=document.createElement("div"),r.className="hide impact-statement-space "+e,r.setAttribute("data-weight",n),[a,r]},k=function(){var t,n,e,a;a=[3,2,1,0,4];for(var i=0,o=a.length;o>i;i++)t=a[i],n=W(a[i],!1),e=N(t,n),f.appendChild(e[0]),m.appendChild(e[1])},I=function(){var t=p.parent().width();void 0==u&&(u=-1*b(timespan.Start,D)+Math.floor(t/2)),requestAnimationFrame(function(){$(),g.style.left=u+"px",m.style.left=u+"px"})},$=function(){var t="<img src='/timeline/img/red.gif' id='today' style='margin-left:"+b(timespan.Start,D)+"px' />",e=p.children(".impact-statement-space"),a=e.length>0;a?n(t).insertAfter(e.first()):p.prepend(t)},j=function(t){return null==t?"no argument was passed in":(M(),k(),t.forEach(S),void I())},O=function(t,n){return(n.match(/\S+color-content($|\s)/g)||[]).join(" ")},Y=function(){h.find(".description-box").attr({style:"order: 0","data-order":"0"}).removeClass(O),p.find(".bar").attr({style:"order: 0","data-order":"0"}).removeClass(O),p.find(".icon").removeClass("hide"),$showButtons=n(".show-button"),$showButtons.each(function(){n(this).removeClass("show-button").addClass("hide-button").text(t.Hide)})},T=function(){d.forEach(function(t){var e="."+t[r];1==t.Skip?n(e).addClass("hide"):n(e).removeClass("hide")})},q=function(){d.forEach(function(t){t.Data.forEach(function(t){if(void 0==t.Weight)return!1;var e=void 0==t.Weight?0:A(t.Weight),a=W(t.Weight,!0),i=t.ID,o="#initiative-description-"+i,r="#initiative-"+i,c=t.Weight.toString();n(o).attr({style:"order: "+e,"data-order":e,"data-weight":c}).addClass(a),n(r).attr({style:"order: "+e,"data-order":e,"data-weight":c}).addClass(a),t.Events.forEach(function(t){if(void 0==t.Skip)return!1;var e="#event-"+t.ID;1==t.Skip?n(e).addClass("hide"):n(e).removeClass("hide")})})})},H=function(){for(var t,e,a,i,o=[3,2,1,0,4],r=0,c=o.length;c>r;r++)t=n(".description-box[data-weight='"+o[r]+"']:not(.hide)").first(),e=n(".impact-statement[data-weight='"+o[r]+"']").first(),a=n(".impact-statement-space[data-weight='"+o[r]+"']").first(),i=t.attr("data-order"),t.length>0&&void 0!=i&&i>0?(e.attr({style:"order: "+i}).removeClass("hide"),a.attr({style:"order: "+i}).removeClass("hide")):(e.addClass("hide"),a.addClass("hide"))},J=function(n){switch(n){case 0:return t.NoImpact;case 1:return t.LowImpact;case 2:return t.MediumImpact;case 3:return t.HighImpact;case 4:return t.BlueprintImpact;default:return t.NoImpact}},W=function(t,n){switch(t){case 0:return 1==n?"no-impact-color-content":"no-impact-color";case 1:return 1==n?"low-impact-color-content":"low-impact-color";case 2:return 1==n?"medium-impact-color-content":"medium-impact-color";case 3:return 1==n?"high-impact-color-content":"high-impact-color";case 4:return 1==n?"blueprint-impact-color-content":"blueprint-impact-color";default:return 1==n?"no-impact-color-content":"no-impact-color"}},A=function(t){switch(t){case 0:return 4;case 1:return 3;case 2:return 2;case 3:return 1;case 4:return 5;default:return 4}},L=function(t){d=t,Y(),T(),q(),H()},z=function(t,e){var a="",i="";e?(a=t.attr("data-title"),i=t.attr("data-description")):(a=t.title,i=t.text),""!=i&&"null"!=i&&(n("#dialog").html(i),n("#ui-id-1").html(a),n("#dialog").dialog("open"))};return{draw:j,sort:L,openDialog:z}}(f),{dataManager:f,ui:h}}(resources,jQuery,moment,helpers);